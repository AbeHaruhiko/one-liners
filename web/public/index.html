<html>
<head>
	<script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="//code.jquery.com/ui/1.11.0/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/jquery.ui.touch-punch.min.js"></script>
</head>
<body>
	<canvas id="canvas" width="300" height="300" style="border:solid 1px black;">
	</canvas>
    <img id="image" style="border: solid 1px black;" width="300" height="300"/>
	<script type="text/javascript">
		// var context = canvas.getContext("2d");
		// ctx.beginPath();
		// ctx.moveTo(20,70);
		// ctx.bezierCurveTo(100,10,150,100,200,20);
		// ctx.stroke();﻿

		// $(function() {
		//     // クリック処理
		//     $('canvas').click( function(event){
		//         // クリックの度に canvas の左上座標を取得する
		//         var rect = $(event.target).offset();
		    
		//         var x = event.pageX - rect.left;
		//         var y = event.pageY - rect.top;

		//         console.log(x + ":" + y);

		//     });
		// });

		drawLine = function(x1, y1, x2, y2) {
			var canvas = $('#canvas').get(0);
			var context = canvas.getContext("2d");
			context.beginPath();
			// context.moveTo(x1, y1);
			// context.lineTo(x2, y1);
			context.moveTo(x1, y1);
			context.lineTo(x1, y2);
			context.stroke();
		};

		$(function() {
			var startX = 0;
			var startY = 0;
			var isDrawing = false;


            $('canvas').mousedown(function(event) {

               isDrawing = true;

                startX = event.pageX - $(this).offset().left;
                startY = event.pageY - $(this).offset().top;
                // startX = $('canvas').offset().left;
                // startY = $('canvas').offset().top;

                console.log(startX, startY);

                event.preventDefault();

            });

            $('canvas').on('touchstart', function(event) {

                event.preventDefault();
                var e = event.originalEvent;
                isDrawing = true;

                startX = e.changedTouches[0].pageX - $(this).offset().left;
                startY = e.changedTouches[0].pageY - $(this).offset().top;
                // startX = $('canvas').offset().left;
                // startY = $('canvas').offset().top;

                console.log(startX, startY);

            });

            $('canvas').mouseup(function(event) {

                endX = event.pageX - $(this).offset().left;
                endY = event.pageY - $(this).offset().top;
                // endX = $('canvas').offset().left;
                // endY = $('canvas').offset().top;

                console.log(startX, startY, endX, endY);

                if (isDrawing) {
                    // drawLine(startX, startY, endX, endY);

                    sq={};                                      //sq 1
                    // sq.left = (endX > startX) ? startX : endX;
                    sq.left = startX;
                    sq.top = (endY > startY) ? startY : endY;
                    sq.width = Math.abs(endX - startX);
                    sq.width = 6;
                    sq.height = Math.abs(endY - startY);

                    // applyWave(sq);
                    applyWaveVartical(sq);
                }


                startX = 0;
                startY = 0;

                isDrawing = false;
            });

            $('canvas').on('touchend', function(event) {
                event.preventDefault();
                var e = event.originalEvent;

                endX = e.changedTouches[0].pageX - $(this).offset().left;
                endY = e.changedTouches[0].pageY - $(this).offset().top;
                // endX = $('canvas').offset().left;
                // endY = $('canvas').offset().top;

                console.log(startX, startY, endX, endY);

                if (isDrawing) {
                    // drawLine(startX, startY, endX, endY);

                    sq={};                                      //sq 1
                    // sq.left = (endX > startX) ? startX : endX;
                    sq.left = startX;
                    sq.top = (endY > startY) ? startY : endY;
                    sq.width = Math.abs(endX - startX);
                    sq.width = 6;
                    sq.height = Math.abs(endY - startY);

                    // applyWave(sq);
                    applyWaveVartical(sq);
                }


                startX = 0;
                startY = 0;

                isDrawing = false;
            });

			// $('canvas').mousemove(function(event) {
			// 	if(isDrawing) {
			// 		endX = event.pageX - $(this).offset().left;
			// 		endY = event.pageY - $(this).offset().top;
			// 		// endX = $('canvas').offset().left;
			// 		// endY = $('canvas').offset().top;

			// 		console.log(endX, endY);

			// 		drawLine(startX, startY, endX, endY);

			// 		startX = endX;
			// 		startY = endY;
			// 	}
			// });






            function applyWave(square){
                var targets=document.getElementsByClassName('wave');
                var class_val;
                var obj,lst,sq;
                var i,j,k;
                var baseline;
                var img_h;
                var a,theta;
                var re,re2, m,s;
                
                // re=/wave ?([\w]+=[#\w\ (\),\.\-]+;){0,4}/;
                // re2=/([\w]+)=([#\w\(\) ,\.\-]+);/g;
                
                // for(i=0;i<targets.length;i++){
                //     lst=getInlineSquares(targets[i]);
                    
                //     for(j=0;j<lst.length;j++){
                        
                //         class_val=targets[i].className;
                //         s=re.exec(class_val)[0];
                        var arg={'color':undefined, 'position':undefined, 'offset':undefined,'line_width':undefined,
                                'wave_length':undefined,'height':undefined};
                //         while((m=re2.exec(s))!=null){
                //             arg[m[1]]=m[2];
                //         }
                        
                        color=arg['color'];
                        position=arg['position'];
                        offset=arg['offset'];
                        lineWidth=arg['line_width'];
                        waveLength=arg['wave_length'];
                        waveHeight=arg['height'];
                        
                        color=(color==undefined)? 'rgba(255,0,0,1)':color;
                        position=(position==undefined)? 'bottom':position;
                        offset= (offset==undefined)? -3:offset;
                        lineWidth=(lineWidth==undefined)? 1.5:lineWidth;
                        waveLength=(waveLength==undefined)? 10:waveLength;
                        waveHeight=(waveHeight==undefined)? 3.0:waveHeight;
                        
                        img_h=waveHeight+(lineWidth*2);
                        
                        a=waveHeight/2;
                        theta=Math.PI*2/waveLength;
                    
                    
                        // sq=lst[j];
                        sq = square;
                        obj=setCanvas($('canvas').get(0), sq, img_h, sq.width, position, offset);
                        var canvas=obj.canvas;
                        baseline=obj.baseY;
                        var ctx=canvas.getContext('2d');
                        ctx.lineWidth=lineWidth;
                        ctx.strokeStyle=color;
                        
                        ctx.beginPath();
                        for(k=0;k < canvas.width;k++){
                            y0=Math.sin(theta*k);
                            y1=Math.sin(theta*(k+1));
                            y0=a*y0;
                            y1=a*y1;
                            
                            ctx.moveTo(k, baseline+y0);
                            ctx.lineTo(k+1, baseline+y1);
                        }
                        ctx.closePath();
                        ctx.stroke();
                //     }
                // }
            } 

            function applyWaveVartical(square){
                var targets=document.getElementsByClassName('wave');
                var class_val;
                var obj,lst,sq;
                var i,j,k;
                var baseline;
                var img_h;
                var a,theta;
                var re,re2, m,s;
                
                var arg={'color':undefined, 'position':undefined, 'offset':undefined,'line_width':undefined,
                        'wave_length':undefined,'height':undefined};

                color=arg['color'];
                position=arg['position'];
                offset=arg['offset'];
                lineWidth=arg['line_width'];
                waveLength=arg['wave_length'];
                waveHeight=arg['height'];
                
                color=(color==undefined)? 'rgba(255,0,0,1)':color;
                position=(position==undefined)? 'bottom':position;
                offset= (offset==undefined)? -3:offset;
                lineWidth=(lineWidth==undefined)? 1.5:lineWidth;
                waveLength=(waveLength==undefined)? 10:waveLength;
                waveHeight=(waveHeight==undefined)? 3.0:waveHeight;
                
                img_h=waveHeight+(lineWidth*2);
                
                a=waveHeight/2;
                theta=Math.PI*2/waveLength;


                // sq=lst[j];
                sq = square;
                obj=setCanvasVartical($('canvas').get(0), sq, img_h, sq.width, position, offset);
                var canvas=obj.canvas;
                // baseline=obj.baseY;
                baseline=startX;
                var ctx=canvas.getContext('2d');
                ctx.lineWidth=lineWidth;
                ctx.strokeStyle=color;
                
                ctx.beginPath();
                for(k=0;k < canvas.height;k++){
                    y0=Math.sin(theta*k);
                    y1=Math.sin(theta*(k+1));
                    y0=a*y0;
                    y1=a*y1;
                    
                    // ctx.moveTo(k, baseline+y0);
                    ctx.moveTo(y0 + 3, k);
                    ctx.lineTo(y1 + 3, k + 1);
                }
                ctx.closePath();
                ctx.stroke();

            } 

            function setCanvas(e, sq, img_h, img_w, position,offset){
                var n=document.getElementsByTagName('canvas').length+1;
                var canvasId='pict'+n.toString();
                var canvas=document.createElement('canvas');
                var top,left,h0,h,w;
                var pos0;
                var offset_p,offset_p_pos;
                var base_y;
                
                canvas.id=canvasId;
                e.parentNode.insertBefore(canvas,e);
                
                
                h=sq.height;
                h0=h;
                top=sq.top;
                w=sq.width;
                left=sq.left;
                
                img_w=(img_w==undefined)? sq.width:img_w;
                
                if (position=='top'){
                    pos0=0;
                }
                else if(position=='center'){
                    pos0=h/2;
                }
                else{       //position == bottom
                    pos0=h;
                    base_y=pos0;
                }
                img_center=pos0-offset;
                img_top=img_center-(img_h/2);
                img_bottom=img_center+(img_h/2);
                
                
                if(img_top<0){
                    h = h-img_top;
                    top=top+img_top;
                    img_center=img_center-img_top;
                    img_bottom=img_center-img_top;
                }
                
                if(img_bottom > h){
                    h = h + (img_bottom - h);
                }
                
                if(img_w>sq.width){
                    left=left-(img_w-sq.width)/2;
                    w=img_w;
                }
                //canvas の位置と大きさを指定
                canvas.style.position="absolute";
                offset_p=e.offsetParent;
                offset_p_pos=getElementPosition(offset_p);
                canvas.style.top  = (top - offset_p_pos.top).toString() + 'px';
                canvas.style.left = (left - offset_p_pos.left).toString() + 'px';
                canvas.width=w;
                canvas.height=h;
                //canvas.style.zIndex= -1;
                //canvas の背景色
                canvas.style.backgroundColor='rgba(0,0,0,0)';
                $(canvas).draggable();
                return {canvas:canvas, baseY:img_center};
            }

            function setCanvasVartical(e, sq, img_h, img_w, position,offset){
                var n=document.getElementsByTagName('canvas').length+1;
                var canvasId='pict'+n.toString();
                var canvas=document.createElement('canvas');
                var top,left,h0,h,w;
                var pos0;
                var offset_p,offset_p_pos;
                var base_x;
                
                canvas.id=canvasId;
                e.parentNode.insertBefore(canvas,e);
                
                
                h=sq.height;
                h0=h;
                top=sq.top;
                w=sq.width;
                left=sq.left;
                
                img_w=(img_w==undefined)? sq.width:img_w;
                
                if (position=='top'){
                    pos0=0;
                }
                else if(position=='center'){
                    pos0=h/2;
                }
                else{       //position == bottom
                    pos0=w;
                    base_x=pos0;
                }
                img_center=pos0-offset;
                img_top=img_center-(img_w/2);
                img_bottom=img_center+(img_w/2);
                
                
                // if(img_top<0){
                //     h = h-img_top;
                //     top=top+img_top;
                //     img_center=img_center-img_top;
                //     img_bottom=img_center-img_top;
                // }
                
                // if(img_bottom > h){
                //     h = h + (img_bottom - h);
                // }
                
                // if(img_w>sq.width){
                //     left=left-(img_w-sq.width)/2;
                //     w=img_w;
                // }
                //canvas の位置と大きさを指定
                canvas.style.position="absolute";
                offset_p=e.offsetParent;
                offset_p_pos=getElementPosition(offset_p);
                canvas.style.top  = (top - offset_p_pos.top).toString() + 'px';
                canvas.style.left = (left - offset_p_pos.left).toString() + 'px';
                canvas.width=w;
                canvas.height=h;
                //canvas.style.zIndex= -1;
                //canvas の背景色
                canvas.style.backgroundColor='rgba(0,0,0,0)';
                canvas.style.border='solid 1px black';
                $(canvas).draggable();
            //    $(canvas).resizable();
                return {canvas:canvas, baseY:img_center};
            }

            function getElementPosition(e) {
            // http://tech.ocit.jp/?eid=703844 のコードを拝借
                var offset_p = e;
                var offsetLeft = 0;
                var offsetTop = 0;
                var offsetHeight=0;
                var offsetWidth=0;

                while (offset_p) {
                    offsetLeft += offset_p.offsetLeft;
                    offsetTop += offset_p.offsetTop;
                    offset_p = offset_p.offsetParent;
                }
                if (navigator.userAgent.indexOf('Mac') != -1 && typeof document.body.leftMargin != "undefined") {
                    offsetLeft += document.body.leftMargin;
                    offsetTop += document.body.topMargin;
                }
                offsetHeight=e.offsetHeight;
                offsetWidth=e.offsetWidth;
                return ({left: offsetLeft, top: offsetTop, width: offsetWidth, height: offsetHeight});
            }







		})

        function  setCanvasBackground(base64data) {
            var imageData = "data:image/jpeg;base64," + base64data;
            var canvas = $('canvas').get(0);
            var context = canvas.getContext("2d");
            var imgObj = new Image();
            imgObj.src = imageData;
            imgObj.onload = function(){
                context.drawImage(imgObj, 0, 0, imgObj.width, imgObj.height);
            }

            // debug用画像確認
            $('#image').style.border = "solid black 1px";
            $('#image').style.width = imgObj.width;
            $('#image').style.height = imgObj.height;
            $('#image').src = imageData;
        }
	</script>
</body>
</html>